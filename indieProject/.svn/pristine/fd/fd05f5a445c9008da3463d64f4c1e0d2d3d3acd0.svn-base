package com.indieProject.app.promovie;

import java.util.List;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.json.simple.JSONObject;
import org.openqa.selenium.By;
import org.openqa.selenium.JavascriptExecutor;
import org.openqa.selenium.WebDriver;
import org.openqa.selenium.WebElement;
import org.openqa.selenium.chrome.ChromeDriver;
import org.openqa.selenium.chrome.ChromeOptions;

import com.indieProject.action.Action;
import com.indieProject.action.ActionForward;

public class LoadMovieDetailAction implements Action{
	private WebDriver driver;
	private String url;
	
    public static final String WEB_DRIVER_ID ="webdriver.chrome.driver";
    public static final String WEB_DRIVER_PATH ="C:\\chromedriver.exe";
	@Override
	public ActionForward execute(HttpServletRequest req, HttpServletResponse resp) throws Exception {
		req.setCharacterEncoding("UTF-8");
		resp.setCharacterEncoding("UTF-8");
		ActionForward forward = new ActionForward();
		
		String title = req.getParameter("title");
		System.out.println(title);
		System.setProperty(WEB_DRIVER_ID,WEB_DRIVER_PATH);
		ChromeOptions options = new ChromeOptions();
		options.addArguments("headless");
		driver = new ChromeDriver(options);
		
		url = "https://indieground.kr/indie/releaseList.do";
		System.out.println("들어옴1");
		List<WebElement> el1 = driver.findElements(By.cssSelector("p.title"));
		System.out.println("들어옴2");

		for(int i = 0; i < el1.size(); i++) {
			System.out.println(el1.get(i).getAttribute("textContent"));
			System.out.println(title);
			if(el1.get(i).getAttribute("textContent").equals(title)) {
				
				WebElement child1 = el1.get(i);
				WebElement child2 = (WebElement) ((JavascriptExecutor) driver).executeScript(
                        "return arguments[0].parentNode;", child1);
				WebElement child3 = (WebElement) ((JavascriptExecutor) driver).executeScript(
                        "return arguments[0].parentNode;", child2);
				
				WebElement parent = (WebElement) ((JavascriptExecutor) driver).executeScript(
                        "return arguments[0].parentNode;", child3);
				parent.click();
				
				Thread.sleep(3000);
				
				
				WebElement libraryView = (WebElement) driver.findElements(By.className("libraryView"));
				
				JSONObject jsonDetail = new JSONObject();
				jsonDetail.put("poster", (libraryView.findElement(By.className("movie_info_poster"))).findElement(By.tagName("img")).getAttribute("src"));
				System.out.println((libraryView.findElement(By.className("movie_info_poster"))).findElement(By.tagName("img")).getAttribute("src"));
				
				jsonDetail.put("title", el1.get(i).getAttribute("textContent"));
				System.out.println(el1.get(i).getAttribute("textContent"));
				
				List<WebElement> intro = driver.findElements(By.tagName("li"));
				jsonDetail.put("length", intro.get(3).getText());
				jsonDetail.put("age", intro.get(4).getText());
				System.out.println(intro.get(3).getText());
				System.out.println(intro.get(4).getText());
				
				List<WebElement> cf = driver.findElements(By.className("cf"));
				jsonDetail.put("company", cf.get(1).findElement(By.tagName("dd")).getText());
				jsonDetail.put("director", cf.get(2).findElement(By.tagName("dd")).getText());
				jsonDetail.put("genre", cf.get(4).findElement(By.tagName("dd")).getText());
				System.out.println(cf.get(1).findElement(By.tagName("dd")).getText());
				System.out.println(cf.get(2).findElement(By.tagName("dd")).getText());
				System.out.println(cf.get(4).findElement(By.tagName("dd")).getText());
				
				WebElement synopTag = driver.findElement(By.className("movie_story")).findElement(By.tagName("dd"));
				jsonDetail.put("synop", synopTag.getText());
				System.out.println(synopTag.getText());
				
				req.setAttribute("jsonDetail", jsonDetail);
				
				forward.setPath("/app/proMovie/proMovieDetail2.jsp");
				forward.setRedirect(false);
		    	//드라이버 종료
		    	try {
					if(driver != null) {
					driver.close();
					driver.quit();
					}//end if
				} catch (Exception e) {
					// TODO Auto-generated catch block
					throw new RuntimeException(e.getMessage());
				}

			}
			
		}
		
		return forward;
	}

}
